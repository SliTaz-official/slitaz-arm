#!/bin/sh
#
# Sat RPi - SliTaz Raspberry Pi Build Tool
#
# Copyright (C) 2012-2014 SliTaz ARM - BSD License
# Author: Christophe Lincoln <pankso@slitaz.org>
#
. /lib/libtaz.sh

#: ${arch=armv6hf}
: ${arch=arm}

# Paths
[ "$work" ] || work="$(pwd)"
distro="$work/distro"
rpi="$work/rpi"
data="$rpi/data"
boot="$distro/boot"
rootfs="$distro/rootfs"
rpi_git="$rpi/git"
kernel="$rpi_git/linux"
firmware="$rpi_git/firmware"
tools="$rpi_git/tools"

# URLs
rpi_mirror="http://mirror.slitaz.org/arm/rpi/"
fw_url="https://github.com/raspberrypi/firmware/raw/master/boot/"
tools_url="https://raw.github.com/raspberrypi/tools/master/mkimage/"
rpi_git_url="git://github.com/raspberrypi/"

# Lists
fwlist="bootcode.bin fixup.dat start.elf"
toolslist="imagetool-uncompressed.py args-uncompressed.txt \
boot-uncompressed.txt"

#
# Functions
#

usage() {
	cat << EOT

$(boldify "Usage:") $(basename $0) [command] [--option]

SliTaz Raspberry Pi Tool

$(boldify "Commands:")
  info          Display paths and distro info
  install       Install SliTaz RPi to sdcard
  gen           Generate a new SliTaz RPi distro
  cook-linux    Build the Raspberry Pi Linux kernel
  get-linux     Get the SliTaz RPi linux package
  get-fw        Download or update minimal RPi firmware
  clone-fw      Clone the RPi firmware repository
  get-prebuilt  Get a prebuilt SliTaz ARM toolchain
  clean         Clean the current work directory

$(boldify "Options:")
  --up          Update for commands: firmware, tools, kernel
  --turbo       Force the RPi to run at the highest arm_freq
  --oclock=     Set the RPi overclocking mode in config.txt
  --vc          Install the RPi VC libraries in /opt/vc
  --nosat       Don't regenerate the distro with sat
  --git         Remove RPi git files on clean up

EOT
}

error() {
	echo "[ $(colorize 31 'ERROR') ] $@"
}

header() {
	newline && boldify "$@" && separator
}

# Get minimal RPi firmware
get_fw() {
	mkdir -p $firmware/boot
	for fw in $fwlist
	do
		[ "$up" ] && rm -f $firmware/boot/$fw
		if [ ! -f "$firmware/boot/$fw" ]; then
			echo -n "Fetching: $fw"
			wget -q --no-check-certificate ${fw_url}${fw} \
				-O $firmware/boot/${fw}; status
		fi
	done
}

# Get all RPi firmware
clone_fw() {
	[ -d "${rpi_git}/firmware" ] && return 0
	mkdir -p ${rpi_git} && cd ${rpi_git}
	git clone --depth 1 ${rpi_git_url}firmware.git
}

# --> will move to tazberry
set_oclock() {
	case "$oclock" in
		none)
			arm_freq=700
			core_freq=250
			sdram_freq=400
			over_voltage=0 ;;
		modest)
			arm_freq=800
			core_freq=300
			sdram_freq=400
			over_voltage=0 ;;
		medium)
			arm_freq=900
			core_freq=333
			sdram_freq=450
			over_voltage=2 ;;
		hight)
			arm_freq=950
			core_freq=450
			sdram_freq=450
			over_voltage=6 ;;
		turbo)
			arm_freq=1000
			core_freq=500
			sdram_freq=500
			over_voltage=6 ;;
	esac
	cat >> ${boot}/config.txt << EOT
arm_freq=$arm_freq
core_freq=$core_freq
sdram_freq=$sdram_freq
over_voltage=$over_voltage
EOT
}

#
# Commands
#

case "$1" in
	info)
		header "SliTaz Raspberry Pi info"
		echo "Firmware : $fwlist" 
		echo "RPi path : $rpi"
		colorize 36 "/boot/cmdline.txt:"
		cat ${boot}/cmdline.txt
		colorize 36 "/boot/config.txt:"
		cat ${boot}/config.txt
		separator && newline ;;
	
	install)
		rpiboot="/media/rpi/boot"
		rpiroot="/media/rpi/rootfs"
		header "SliTaz Raspberry Pi install"
		if [ ! "$dev" ]; then
			echo "Missing: --dev= cmdline option"
			newline && exit 1
		fi
		
		# Store sdcard partition(s) list
		fdisk -l /dev/${dev} | grep "^/dev/$dev" | awk '{print $1}' \
			> ${data}/sdcard.part
		partnb=$(cat ${data}/sdcard.part | wc -l)
		if [ "$partnb" != 3 ]; then
			error "SliTaz RPi needs 3 partitions on the sdcard" 
			newline && exit 1
		fi
		
		# Mount sdcard
		if mount | grep -q "^/dev/$dev[1-3]"; then
			debug "Unmounting: /dev/$dev"
			umount /dev/${dev}1 2>/dev/null || exit 1
			umount /dev/${dev}3 2>/dev/null || exit 1
		fi
		echo -n "Mounting: /dev/$dev partitions"
		mkdir -p ${rpiboot} ${rpiroot}
		mount /dev/${dev}1 ${rpiboot}
		mount /dev/${dev}3 ${rpiroot}; status
		echo -n "Cleaning: filesystem directories"
		for dir in bin dev etc lib media mnt proc sbin sys tmp usr var run
		do
			rm -rf ${rpiroot}/${dir}
		done; status
		echo -n "Installing: boot files"
		cp -rf ${boot}/* ${rpiboot}; status
		echo -n "Installing: rootfs files"
		cp -a ${rootfs}/* ${rpiroot}; status
		
		# Unmount
		echo -n "Unmounting: RPi sdcard"
		umount ${rpiboot} || exit 1
		umount ${rpiroot} || exit 1
		status
		
		rm -f ${data}/sdcard.part
		separator && newline ;;
		
	ls-dev)
		newline
		fdisk -l | grep "^Disk /dev/sd*" 
		newline ;;
	
	gen)
		# Separate boot files since the Raspberry Pi boots off a FAT32 /boot 
		# partition on the sdcard.
		: ${flavor=rpi-base}
		: ${oclock=none}
		
		# Use the rootfs generated by sat
		if [ ! -x "/usr/bin/sat" ]; then
			error "Sat is not installed" && exit 1
		fi
		check_root
		
		# We may want to simply regenerate the RPi distro
		if [ ! "$nosat" ]; then
			sat gen --work="$work" --flavor="$flavor" --kmap --noinit --nolinux
		fi
		
		header "SliTaz Raspberry Pi distro"
		
		# Boot firmware
		echo -n "Copying: firmware files..."
		mkdir -p ${boot} && get_fw
		for fw in $fwlist
		do
			cp ${firmware}/boot/${fw} ${boot}
		done
		status
		
		# TazBerry
		echo -n "Installing TazBerry..."
		cp -f ${rpi}/tazberry ${rootfs}/usr/bin
		status
		
		# CGI Admin
		#echo -n "Installing TazBerry CGI..."
		#cp -a ${rpi}/cgi-adm/* ${rootfs}/var/www/adm
		#status
		
		# Overclocking
		echo -n "Setting: Overclocking..."
		set_oclock; status
		
		# Force turbo
		if [ "$turbo" ]; then
			if ! fgrep 'force_turbo=1' ${boot}/config.txt; then
				echo -n "Config: force_turbo=1"
				echo "force_turbo=1" >> ${boot}/config.txt; status
			fi
		fi
		
		# RPi VC libraries
		if [ "$vc" ]; then
			vc="${rootfs}/opt/vc"
			if [ ! -d "$firmware/opt/vc" ]; then
				error "Missing firmware git repository" && exit 1
			fi
			echo -n "Copying: standard VC libraries"
			cp -a ${firmware}/opt ${rootfs}
			# --> armv6hf
			#cp -a ${firmware}/hardfp/opt ${rootfs}
			chown -R root.root ${rootfs}/opt
			status
			echo -n "Cleaning: VC libraries devel files"
			cross_tools="/cross/${arch}/tools/bin"
			rm -rf ${vc}/include ${vc}/src ${vc}/lib/*.a
			${cross_tools}/${arch}-slitaz-linux-gnueabi-strip -s ${vc}/lib/*.so
			status
		fi
		
		# Kernel at last
		. $data/linux-*/receipt
		kvers="$VERSION"
		kpkg="$rootfs/var/lib/tazpkg/installed/linux"
		fs="$data/linux-$kvers/fs"
		ksize=$(du -sh $fs | awk '{print $1}')
		if [ -d "$fs" ]; then
			echo -n "Copying: kernel $kvers ($ksize)"
			rm -rf ${rootfs}/lib/modules
			cp -rf ${fs}/lib/* ${rootfs}/lib
			cp -f  ${fs}/boot/* ${boot}
			mkdir -p ${kpkg}
			cd ${data}/linux-${kvers}
			cp -f files.list md5sum receipt ${kpkg}
			status
		else
			echo "SliTaz RPi Kernel: not used"
		fi
		
		separator
		echo -n "Boot: $(du -sh $boot | awk '{print $1}') "
		echo "- Rootfs: $(du -sh $rootfs | awk '{print $1}')" 
		newline ;;
	
	cook-linux)
		# Native SliTaz Toolchain and cross toolchain must be installed
		check_root
		install="$data/linux-install"
		if [ ! -d "/cross/$arch" ]; then
			error "Missing cross toolchain in: /cross/$arch"
			exit 1
		fi
		
		# Kernel source
		cd ${rpi_git}
		[ -d "$kernel" ] || git clone --depth 1 ${rpi_git_url}linux.git
		
		# Compile
		[ "$clean" ] && rm -rf ${install}
		if [ ! -d "$install" ]; then
			cd ${kernel}
			export PATH=$PATH:/cross/${arch}/tools/bin
			export HOST_SYSTEM=${arch}-slitaz-linux-gnueabi
			make mrproper &&
			make ARCH=arm bcmrpi_defconfig
			echo "Patching SliTaz RPi Linux .config"
			patch -p0 -i ${rpi}/linux-rpi.patch || exit 1 
			make ARCH=arm CROSS_COMPILE=${HOST_SYSTEM}- zImage &&
			make ARCH=arm CROSS_COMPILE=${HOST_SYSTEM}- modules &&
			make ARCH=arm CROSS_COMPILE=${HOST_SYSTEM}- \
				INSTALL_MOD_PATH=${install} modules_install || exit 1
			mkdir -p ${install}/boot
			cp -a arch/arm/boot/zImage ${install}/boot/kernel.img
		fi
		
		# Kernel version
		kvers=$(ls ${install}/lib/modules)
		kvers=${kvers%-slitaz-rpi+}+
		
		# Compress modules
		cd ${install}/lib/modules/${kvers%+}-slitaz-rpi+/ || exit 1
		mods=$(find . -name "*.ko$" | wc -l)
		newline
		echo "Compressing kernel modules: $mods"
		find . -name "*.ko$" -exec gzip '{}' \; #2> /dev/null
		
		# Rebuild modules.dep
		cd ${install}
		depmod -b . ${kvers%+}-slitaz-rpi+
		
		# Kernel
		fs="$data/linux-$kvers/fs"
		echo "Kernel version: $kvers"
		if [ -d "$install" ]; then
			rm -rf ${data}/linux-${kvers}
			mkdir -p ${data}/linux-${kvers}
			cp -a ${install} ${fs}
			rm -f ${fs}/lib/modules/*/build \
				${fs}/lib/modules/*/source
		fi
		
		# Pack .tazpkg
		cd ${data}
		echo "Creating package: receipt"
		cat > linux-$kvers/receipt << EOT
# SliTaz package receipt

PACKAGE="linux"
VERSION="$kvers"
SHORT_DESC="SliTaz Linux Kernel for the Raspberry Pi."
WEB_SITE="http://www.kernel.org"

EOT
		tazpkg pack linux-$kvers ;;
	
	get-fw)
		get_fw ;;
		
	get-tools)
		get_tools ;;
		
	get-linux)
		# Precook RPi kernel
		check_root
		mkdir -p ${data}
		
		# Last version
		rm -f ${data}/linux-version.txt
		if busybox wget -q -s ${rpi_mirror}/last-linux.txt; then
			echo -n "Fetching latest Kernel string..."
			wget -q ${rpi_mirror}/last-linux.txt \
				-O ${data}/linux-version.txt || exit 1
			status
		else
			echo "Mirror is unreachable" && exit 1
		fi
		kvers=$(cat $data/linux-version.txt)
		[ "$up" ] && rm -rf ${data}/linux-${kvers}*
		echo "Kernel version: $kvers"
		
		# Download
		if [ ! -f "$data/linux-$kvers.tazpkg" ]; then
			echo -n "Fetching latest Linux package..."
			wget -q ${rpi_mirror}/linux-${kvers}.tazpkg \
				-O ${data}/linux-${kvers}.tazpkg; status
		fi
		
		# Extract
		if [ ! -d "$data/linux-$kvers" ]; then
			cd ${data} && tazpkg extract linux-${kvers}.tazpkg
		fi 
		rm -f ${data}/linux-version.txt ;;
		
	get-prebuilt)
		# --> in cross ??
		: ${arch=arm}
		name="slitaz-$arch-toolchain"
		vers="20140304"
		tarball="$name-$vers.tar.bz2"
		url="http://mirror.slitaz.org/packages/cross/"
		mkdir -p /cross
		cd /cross
		if [ ! -f "$tarball" ]; then
			if busybox wget -qs ${url%/}/${tarball}; then
				busybox wget ${url%/}/${tarball}
			else
				echo "Toolchain URL is unreachable" && exit 1
			fi 
		fi
		if [ ! -d "${name}-${vers}" ]; then
			echo "Extracting: $tarball"
			tar xjf ${tarball}
		fi
		echo "Copying: ${name}-${vers}/${arch}"
		mkdir -p ${arch}
		cp -a ${name}-${vers}/${arch}/* ${arch} 
		echo "Tools path: /cross/${arch}/tools/bin" ;;
	
	clone-fw)
		clone_fw ;;
		
	release)
		# Used to release official SliTaz RPi images
		cd ${distro} || exit 1
		if [ ! "$flavor" ]; then
			. $distro/rootfs/etc/slitaz/flavor.conf || exit 1
			flavor="$FLAVOR"
		fi
		dname="slitaz-$flavor-$(date +%Y%m%d)"
		dsize=$(du -sh $distro | awk '{print $1}' | cut -d "." -f 1)
		rm -rf ${dname} && mkdir ${dname}
		cp -a boot rootfs ${dname}
		cat > ${dname}/README << EOT
SliTaz Raspberry Pi - $flavor-$(date +%Y%m%d) - http://arm.slitaz.org/rpi
--------------------------------------------------------------------------------

boot/   : Must be copied to a FAT32 partition
rootfs/ : Must be copied to a ext4 or btrfs partition

Manual Installation. Assuming the sdcard is /dev/sdc and has got 3 
partitions (boot,swap,root). Mount the sdcard, copy files, unmount:

 # mkdir -p /media/rpi/boot /media/rpi/root
 
 # mount /dev/sdc1 /media/rpi/boot
 # mount /dev/sdc3 /media/rpi/root
 
 # cp -a boot/* /media/rpi/boot
 # cp -a rootfs/* /media/rpi/root
 
 # umount /media/rpi/boot
 # umount /media/rpi/root

--------------------------------------------------------------------------------

EOT
		echo "Creating: ${dname}.tar.xz"
		tar -cJf ${dname}.tar.xz ${dname}
		echo "Creating: ${dname}.md5"
		md5sum ${dname}.tar.xz > ${dname}.md5
		rm -rf ${dname} ;;
	
	clean)
		echo "Cleaning: $rpi"
		rm -rf ${data} 
		[ "$git" ] && rm -rf ${rpi_git} ;;
	*) usage ;;
esac
exit 0
