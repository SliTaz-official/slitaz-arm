#!/bin/sh
#
# Sat - SliTaz ARM Tool
#
# Copyright (C) 2012-2014 SliTaz ARM - BSD License
# Author: Christophe Lincoln <pankso@slitaz.org>
#
. /lib/libtaz.sh
#. /usr/lib/slitaz/libpkg.sh
. /etc/slitaz/slitaz.conf

# Internal variables: libtaz.sh set: --work= --init=
[ "$work" ] || work="$(pwd)"
[ "$init" ] || init="gz"
initramfs="slitaz-arm.$init"
packages="$work/packages"
distro="$work/distro"
flavors="$work/flavors"
rootfs="$distro/rootfs"

# http://mirror.slitaz.org/packages/cooking/arm/
mirror="http://cook.slitaz.org/cross/arm/packages/"

# Help and usage
usage() {
	cat << EOT

$(boldify "Usage:") $(basename $0) [command|--options]

$(boldify "Commands:")
  gen        Generate a distro cpio/gzip initramfs
  flavors    List and give info about flavors
  ckpkgs     Distro packages dependencies check
  clean      Clean up the work directory
  vdisk      Create a virtual disk to be used by Qemu
  emu        Emulate the distro with qemu-system-arm
  mirror     Download or sync the SliTaz ARM mirror

$(boldify "Options:")
  --spk      Include Spk package manager in the distro
  --kmap     Include the system keymap config in the distro
  --work=    Path to work dir with packages and rootfs
  --size=    Specify optional vdisk size (default 20Mb)
  --init=    Specify the initramfs compression: gz bz2 xz
  --flavor=  Generate specified SliTaz ARM flavor

EOT
}

# --> use libpkg.sh when released (function is shared with spk)
# Check mirror ID: return 1 if no changes or mirror unreachable
check_mirror_id() {
	[ "$forced" ] && rm -f ID
	[ -f "ID" ] || echo $$ > ID
	mv ID ID.bak
	if busybox wget -qs ${mirror%/}/ID 2>/dev/null; then
		busybox wget -q ${mirror%/}/ID
	else
		gettext "Mirror is unreachable"; newline
		return 1
	fi
	if [ "$(cat ID)" == "$(cat ID.bak)" ]; then
		gettext "Mirror is up-to-date"; newline
		return 1
	fi
}

#
# Commands
#

case "$1" in
	gen)
		time=$(date +%s)
		check_root
		newline && boldify "Generating SliTaz ARM distro"
		separator
		rm -rf $distro && mkdir -p ${rootfs}
		
		# Get --flavor= packages lists
		if [ "$flavor" ]; then
			echo -n "Getting $flavor packages.list..."
			cp -f $flavors/$flavor/packages.list $distro 2>/dev/null
			status
		fi

		# Packages
		rm -f $distro/packages.full
		if [ -f "$distro/packages.list" ]; then
			for pkg in $(cat $distro/packages.list)
			do
				IFS="|"
				grep "^$pkg |" $work/mirror/packages.desc | while read pkg version desc
				do
					echo ${pkg}-${version}-arm.tazpkg | sed s'/ //'g \
						>> $distro/packages.full
				done
				unset IFS
			done
			cd ${work}/mirror
		else
			if [ ! -d "$packages" ]; then
				echo "Missing distro/packages.list or packages/ directory"
				echo "" && exit 1
			fi
			echo -n "Using packages directory..."
			cd $packages && ls -1 > $distro/packages.full
			status
		fi
		
		# Deps install is not well handled by tazpkg/spk actually.
		# So simply install all packages and don't resolve deps.
		for pkg in $(cat $distro/packages.full)
		do
			pkgdir=$(basename $pkg .tazpkg)
			db=${rootfs}/var/lib/tazpkg
			echo -n "Installing: $(basename $pkg)"
			tazpkg extract $pkg >/dev/null
			. $pkgdir/receipt
			mkdir -p $db/installed/$PACKAGE
			cp $pkgdir/receipt $pkgdir/files.list \
				$db/installed/$PACKAGE
			cp -a $pkgdir/fs/* $distro/rootfs && rm -rf $pkgdir
			md5sum $(basename $pkg) >> $db/installed.md5
			status
		done

		# Install spk if requested. Spk multiarch support must be tested
		if [ "$spk" ]; then
			hg=http://hg.slitaz.org
			echo -n "Installing: spk ($hg)"
			cd $work
			[ -d "spk" ] || hg clone $hg/spk >/dev/null 2>/dev/null
			cd $work/spk
			[ "$noup" ] || hg pull -u >/dev/null
			make DESTDIR=${rootfs} install >/dev/null
			status
		fi

		# Move kernel outside the distro
		if [ -d "$distro/rootfs/boot" ]; then
			mv -f ${rootfs}/boot/linux-* ${distro}/linux-arm
			chmod -x ${distro}/linux-arm
		else
			echo -n "Missing: ${rootfs}/boot"; false
			status && exit 1
		fi

		# SLITAZ_ARCH
		echo -n "Setting SliTaz arch to: arm"
		sed -i s"/SLITAZ_ARCH=.*/SLITAZ_ARCH=\"arm\"/" \
			${rootfs}/etc/slitaz/slitaz.conf
		status

		# Mirror
		echo "$mirror" > ${rootfs}/var/lib/tazpkg/mirror

		# /init & /run
		cd ${rootfs}
		rm init && ln -s /bin/busybox init
		mkdir -p run

		# Update modules.dep
		. var/lib/tazpkg/installed/linux/receipt
		depmod -b . ${VERSION}-slitaz

		# Custom rootfs: make sure all files belong to root
		if [ -d "$work/rootfs" ]; then
			echo -n "Copying custom ARM: rootfs"
			tmp=$distro/tmp-$$
			mkdir -p $tmp
			cp -r $work/rootfs/* $tmp
			chown -R root.root $tmp
			cp -a $tmp/* ${rootfs} && rm -rf $tmp
			status
		fi
		
		# Custom flavor rootfs
		if [ -d "$flavors/$flavor/rootfs" ]; then
			echo -n "Copying $flavor ARM: rootfs"
			tmp=$distro/tmp-$$
			mkdir -p $tmp
			cp -r $flavors/$flavor/rootfs/* $tmp
			chown -R root.root $tmp
			cp -a $tmp/* ${rootfs} && rm -rf $tmp
			status
		fi
		
		# --kmap
		if [ "$kmap" ]; then
			echo -n "Copying local: /etc/keymap.conf"
			cp -a /etc/keymap.conf ${rootfs}
			status
		fi

		# Rootfs cpio: gzip xz --> /usr/lib/slitaz/liblive.sh ???
		echo -n "Compressing initramfs: $initramfs"
		case "$initramfs" in
			*.bz2) find . | cpio -o -H newc | bzip2 > ../$initramfs ;;
			*.gz) find . | cpio -o -H newc | gzip -9 > ../$initramfs ;;
			*.xz) find . | cpio -o -H newc | xz -9 --format=lzma > ../$initramfs ;;
		esac
		
		# Summary
		status
		separator && echo ""
		boldify "SliTaz ARM distro summary"
		separator
		time=$(($(date +%s) - $time))
		echo -n "Build time     : " && echo "${time}s"
		echo -n "Initramfs size : " && du -sh $distro/$initramfs | awk '{print $1}'
		echo -n "Rootfs size    : " && du -sh ${rootfs} | awk '{print $1}'
		echo -n "Packages       : " && ls $db/installed | wc -l
		separator && newline ;;
		
	flavors)
		newline
		echo -n "$(boldify 'Flavor')" && indent 14 "$(boldify 'Packages')"
		separator
		for flavor in $(ls $flavors)
		do
			pkgs=$(cat $flavors/$flavor/packages.list | wc -l)
			echo -n "$flavor" && indent 14 "$pkgs"
		done
		newline ;;
	
	ckpkgs)
		installed="${rootfs}/var/lib/tazpkg/installed"
		SLITAZ_ARCH="arm"
		count=0
		if [ ! -d "$installed" ]; then
			echo "Missing distro rootfs" && exit 1
		fi
		echo ""
		echo -n "$(boldify 'Package name')"
		indent 24 "$(boldify 'Missing dependencie')"
		separator
		for pkg in ${installed}/*
		do
			. $pkg/receipt
			for dep in $DEPENDS
			do
				if [ ! -d "${installed}/$dep" ]; then
					echo -n "$(colorize 34 $PACKAGE)" && indent 24 "$dep"
					count=$(($count + 1))
				fi
			done
			unset DEPENDS
		done
		if [ "$count" == 0 ]; then
			echo "No missing dependencies" 
		fi
		separator
		echo -n "Installed packages: "; colorize 32 $(ls $installed | wc -l)
		newline ;;
	
	clean)
		check_root
		echo -n "Cleaning: distro"
		rm -rf $distro && status
		if [ "$spk" ]; then
			echo -n "Cleaning: spk"
			rm -rf $work/spk && status
		fi ;;
	
	vdisk)
		# Lets use and HD in Qemu to store files|packages|whatever
		vdisk="vdisk.img"
		: ${size=20}
		cd $work
		dd if=/dev/zero of=$vdisk bs=1M count=$size
		mkfs.ext4 -q -T ext4 -L "SliTaz" -F $vdisk ;;
	
	emu)
		cd $work
		[ -f "vdisk.img" ] && opts="-hda vdisk.img"
		qemu-system-arm -m 256 $opts \
			-M versatilepb -cpu arm1176 \
			-kernel ${distro}/linux-arm \
			-initrd ${distro}/${initramfs} ;;
	
	mirror)
		#
		# --> spk-mirror $mirror --sync --dest=/path ???
		#
		count=0
		newline && boldify "Syncing SliTaz ARM mirror"
		separator
		mkdir -p $work/mirror && cd $work/mirror
		
		echo -n "URL: " && colorize 34 "$mirror"
		if ! check_mirror_id; then
			newline && exit 0
		fi
		for list in packages.list packages.desc packages.md5; do
			echo -n "Fetching: $list"
			rm -f $list && wget -q ${mirror%/}/$list
			status
		done
		echo -n "Checking packages $SUM..."
		for pkg in $(cat $work/mirror/packages.list); do
			pkg=${pkg}.tazpkg
			if [ ! -f "$pkg" ]; then
				count=$(($count + 1))
				[ "$count" == 1 ] && newline
				echo -n "Fetching: ${pkg}"
				wget -q ${mirror%/}/$pkg
				status
			fi
			pkgsum=$($CHECKSUM $pkg)
			debug "$pkgsum"
			[ "$pkgsum" ] || pkgsum=$$
			mirsum=$(fgrep -h $pkgsum packages.$SUM)
			debug "$mirsum"
			if [ ! "$pkgsum" == "$mirsum" ]; then
				count=$(($count + 1))
				[ "$count" == 1 ] && newline
				echo -n "Fetching: ${pkg}.tazpkg"
				rm -f $pkg
				wget -q ${mirror%/}/$pkg
				status
			fi
		done
		[ "$count" == 0 ] && status 
		separator && newline ;;
	
	*) usage ;;
esac
exit 0
